<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://shelf.io/wp-content/uploads/2019/04/favicon.png">
    <link rel="stylesheet" href="index.css">
    <title>Shelf Tech Stack</title>
    <script src="index.js"></script>
    <script>
        function getFaviconUrl(domain) {
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
        }
    </script>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <div class="header-text">
                <h1>Shelf Tech Stack</h1>
                <p>Discover the tools and technologies used to build Shelf's innovative products and services.</p>
            </div>
        </div>
    </header>

    <div class="main-container">

        <div id="tech-stack-content">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        renderTechStack();

        function renderTechStack() {
            const container = document.getElementById('tech-stack-content');
            Object.entries(pageData.techStack).forEach(([categoryId, categoryData]) => {
                const category = CATEGORIES.find(cat => cat._id === categoryId);

                if (!category) {
                    console.warn(`Category with ID '${categoryId}' not found in CATEGORIES array`);
                    return;
                }

                const categorySection = document.createElement('section');
                categorySection.className = 'category-section';
                categorySection.setAttribute('aria-labelledby', `heading-${categoryId}`);

                // Create fixed header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.id = `heading-${categoryId}`;
                categoryHeader.setAttribute('role', 'button');
                categoryHeader.setAttribute('tabindex', '0');
                categoryHeader.setAttribute('aria-expanded', 'true');
                categoryHeader.setAttribute('aria-controls', `content-${categoryId}`);
                categoryHeader.innerHTML = `
                    <div class="category-icon" aria-hidden="true">${category.icon}</div>
                    <h2 class="category-title">${category.name}</h2>
                    <div class="collapse-toggle" aria-hidden="true">
                        <span class="toggle-icon"></span>
                    </div>
                `;

                // Create collapsible content
                const details = document.createElement('details');
                details.open = true;
                details.className = 'category-details';
                details.id = `content-${categoryId}`;

                details.innerHTML = `
                    <summary style="display: none;"></summary>
                    <div class="category-content">
                        <p class="category-description">${category.description}</p>
                        <div class="tools-grid" role="list" aria-label="${category.name} tools">
                            ${categoryData.tools.map(tool => `
                                <article class="tool-card" role="listitem">
                                    <div class="icon-container">
                                        <div class="icon-placeholder" aria-hidden="true"></div>
                                        <img src="${getFaviconUrl(tool.icon)}" 
                                             alt="${tool.name} logo" 
                                             class="tool-icon loading" 
                                             onload="handleImageLoad(this)" 
                                             onerror="handleImageError(this)" 
                                             data-retry-count="0" 
                                             data-domain="${tool.icon}">
                                    </div>
                                    <h3 class="tool-name">${tool.name}</h3>
                                    <div class="tooltip" role="tooltip" aria-describedby="tool-${categoryId}-${tool.name.replace(/\s+/g, '-').toLowerCase()}">${tool.usage}</div>
                                </article>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Add click event to entire header
                const toggleSection = () => {
                    const isOpen = details.open;
                    details.open = !isOpen;
                    categoryHeader.setAttribute('aria-expanded', (!isOpen).toString());
                };

                categoryHeader.addEventListener('click', toggleSection);
                categoryHeader.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleSection();
                    }
                });

                categorySection.appendChild(categoryHeader);
                categorySection.appendChild(details);
                container.appendChild(categorySection);
            });

        }



        function handleImageLoad(img) {
            const placeholder = img.parentElement.querySelector('.icon-placeholder');
            img.classList.remove('loading');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }
        }

        function handleImageError(img) {
            const toolName = img.alt;
            const retryCount = parseInt(img.dataset.retryCount) || 0;
            const maxRetries = 3;

            if (retryCount < maxRetries) {
                const nextRetry = retryCount + 1;
                const delay = nextRetry * nextRetry * 1000; // 1s, 4s, 9s delays

                img.dataset.retryCount = nextRetry;

                setTimeout(() => {
                    const domain = img.dataset.domain;
                    img.src = getFaviconUrl(domain) + '&retry=' + nextRetry;
                }, delay);
            }
        }



    </script>
</body>

</html>